<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Koalitionsrechner & Prognose</title>
<style>
  body {
    margin:0; padding:24px;
    background:#0b0f14; color:#e8eef7;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
  }
  h1 {margin:0 0 12px;}
  .wrap {display:grid; gap:16px; grid-template-columns:380px 1fr;}
  @media(max-width:980px){.wrap{grid-template-columns:1fr}}
  .card {
    background:#121823; border-radius:12px;
    padding:16px; border:1px solid rgba(255,255,255,.1);
  }
  .row {display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap}
  input,select,button {
    border-radius:8px; border:1px solid rgba(255,255,255,.2);
    background:#0f1420; color:#e8eef7; padding:8px 12px;
  }
  button {cursor:pointer; font-weight:600}
  .party-row {
    display:grid; grid-template-columns:26px 1.2fr .9fr .7fr 1fr 26px;
    gap:6px; align-items:center; margin:6px 0;
  }
  .del {cursor:pointer; text-align:center}
  .legend {display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
  .legend .item {display:flex; gap:6px; align-items:center; font-size:13px;
    background:#0f1420; border:1px solid rgba(255,255,255,.1);
    padding:6px 10px; border-radius:999px;}
  .sw{width:14px; height:14px; border-radius:4px; display:inline-block}
  .pill{display:inline-flex; gap:6px; background:#0f1420; padding:6px 10px; border-radius:999px; font-size:13px}
  .ok{color:#37d07a} .bad{color:#ff6a6a}
  svg {width:100%; height:auto}
  .bar {fill:steelblue;}
  .bar-label {font-size:14px; fill:white; text-anchor:middle;}
  .axis text {fill:#e8eef7; font-size:12px}
  .axis path, .axis line {display:none;} /* <-- Gridlines raus */
</style>
</head>
<body>
  <h1>Koalitionsrechner & Prognose</h1>

  <div class="wrap">
    <section class="card" id="inputsCard">
      <div class="row">
        <div><label>Gesamtsitze</label><input id="totalSeats" type="number" value="630"></div>
        <div><label>Sperrklausel (%)</label><input id="threshold" type="number" value="5" step="0.1"></div>
      </div>
      <div class="row">
        <div><label>Wahlverfahren</label>
          <select id="method">
            <option value="sls" selected>Sainte-Laguë/Schepers</option>
            <option value="dhondt">d’Hondt</option>
            <option value="hare">Hare-Niemeyer</option>
          </select>
        </div>
      </div>
      <div class="row">
        <button id="addRowBtn" type="button">+ Partei hinzufügen</button>
        <button id="calcBtn" type="button">Neu berechnen</button>
      </div>
      <div id="partyList"></div>
    </section>

    <section class="card">
      <h3>Sitzverteilung</h3>
      <svg id="seatChart" viewBox="0 0 900 620" preserveAspectRatio="xMidYMin meet"></svg>
      <div class="legend" id="legend"></div>
      <div class="row" style="margin-top:12px">
        <div class="pill">Mehrheit: <span id="majorityLbl">316</span></div>
        <div class="pill">Koalition Sitze: <span id="coalSeats">0</span></div>
        <div class="pill">Mehrheit? <span id="coalMajority" class="bad">nein</span></div>
      </div>

      <h3>Koalitionen</h3>
      <div class="row">
        <select id="coalitionSelect">
          <option value="">– wählen –</option>
          <option value="cdu,spd">GroKo (Schwarz-Rot)</option>
          <option value="cdu,grüne">Schwarz-Grün</option>
          <option value="cdu,fdp">Schwarz-Gelb</option>
          <option value="cdu,grüne,fdp">Jamaika</option>
          <option value="spd,grüne,fdp">Ampel</option>
          <option value="spd,linke,grüne">Rot-Rot-Grün</option>
        </select>
      </div>
      <div id="coalitionChecklist"></div>

      <h3>Prognose (Balkendiagramm)</h3>
      <svg id="barChart" width="600" height="400"></svg>
      <button id="animateBarsBtn">Nächste Partei animieren</button>
    </section>
  </div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const GREY="#b7bdc7";
function isOther(n){n=(n||"").toLowerCase();return n.includes("andere")||n.includes("sonstige");}

const defaultParties=[
  {name:"CDU",color:"#000000",pct:28},
  {name:"SPD",color:"#E3000F",pct:22},
  {name:"Grüne",color:"#1FA12E",pct:15},
  {name:"FDP",color:"#FFED00",pct:6},
  {name:"AfD",color:"#009EE0",pct:16},
  {name:"Linke",color:"#BE3075",pct:6},
  {name:"BSW",color:"#FF6A00",pct:7}
];

let selectedCoalition=new Set();

/* ===== Seat allocation (simplified Sainte-Laguë) ===== */
function sls(parties,seats){
  const f=1000000,Q=[];
  parties.forEach((p,i)=>{
    const v=p.pct*f;
    for(let k=0;k<seats+5;k++){Q.push({i,val:v/(2*k+1)})}
  });
  Q.sort((a,b)=>b.val-a.val);
  const res=new Array(parties.length).fill(0);
  Q.slice(0,seats).forEach(q=>res[q.i]++);
  return res;
}
function computeSeats(parties,totalSeats,threshold,method){
  const valid=parties.filter(p=>!isOther(p.name)&&p.pct>=threshold);
  const counts=sls(valid,totalSeats);
  return parties.map(p=>{
    const i=valid.findIndex(v=>v.name===p.name);
    return {...p,seats:i>=0?counts[i]:0};
  });
}

/* ===== Draw Half Ring ===== */
function arcD(r1,r2,a0,a1){
  const large=(a1-a0)>Math.PI?1:0;
  const x0o=r1*Math.cos(a0),y0o=r1*Math.sin(a0);
  const x1o=r1*Math.cos(a1),y1o=r1*Math.sin(a1);
  const x1i=r2*Math.cos(a1),y1i=r2*Math.sin(a1);
  const x0i=r2*Math.cos(a0),y0i=r2*Math.sin(a0);
  return `M${x0o},${y0o}A${r1},${r1} 0 ${large} 1 ${x1o},${y1o}L${x1i},${y1i}A${r2},${r2} 0 ${large} 0 ${x0i},${y0i}Z`;
}
function drawHalfRing(data,totalSeats){
  const svg=$("#seatChart");
  svg.innerHTML="";
  const w=900,h=620,cx=w/2,cy=h*0.85;
  const g=document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("transform",`translate(${cx},${cy})`);
  svg.appendChild(g);

  const total=data.reduce((a,b)=>a+b.seats,0)||totalSeats;
  let start=Math.PI;
  data.forEach(p=>{
    const share=p.seats/total, sweep=share*Math.PI;
    const path=document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d",arcD(260,100,start,start+sweep));
    path.setAttribute("fill",selectedCoalition.has(p.name)?p.color:GREY);
    g.appendChild(path);
    start+=sweep;
  });
}

/* ===== Legend ===== */
function renderLegend(data){
  const legend=$("#legend"); legend.innerHTML="";
  data.forEach(p=>{
    if(p.seats>0){const d=document.createElement("div");d.className="item";
      d.innerHTML=`<span class="sw" style="background:${p.color}"></span>${p.name} – ${p.seats}`;legend.appendChild(d);}
  });
}

/* ===== Coalition handling ===== */
function renderChecklist(data){
  const wrap=$("#coalitionChecklist"); wrap.innerHTML="";
  data.forEach(p=>{
    if(p.seats>0){
      const lab=document.createElement("label");
      const checked=selectedCoalition.has(p.name)?"checked":"";
      lab.innerHTML=`<input type="checkbox" data-n="${p.name}" ${checked}> ${p.name}`;
      wrap.appendChild(lab);
    }
  });
  wrap.querySelectorAll("input").forEach(cb=>{
    cb.addEventListener("change",()=>{
      if(cb.checked) selectedCoalition.add(cb.dataset.n); else selectedCoalition.delete(cb.dataset.n);
      recompute();
    });
  });
}
$("#coalitionSelect").addEventListener("change",()=>{
  selectedCoalition.clear();
  const val=$("#coalitionSelect").value;
  if(val){val.split(",").forEach(n=>selectedCoalition.add(n.trim()));}
  recompute();
});

/* ===== Prognose Balkendiagramm ===== */
let barIndex=0;
function drawBars(data){
  const svg=d3.select("#barChart");
  const w=600,h=400;
  svg.attr("viewBox",[0,0,w,h]);
  svg.selectAll("*").remove();

  const x=d3.scaleBand().domain(data.map(d=>d.name)).range([60,w-20]).padding(0.3);
  const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.pct)+5]).range([h-40,20]);

  svg.append("g").attr("transform",`translate(0,${h-40})`).call(d3.axisBottom(x));
  svg.append("g").attr("transform","translate(60,0)").call(d3.axisLeft(y).ticks(5));

  svg.selectAll(".bar")
    .data(data).enter().append("rect")
    .attr("class","bar")
    .attr("x",d=>x(d.name))
    .attr("y",y(0))
    .attr("width",x.bandwidth())
    .attr("height",0)
    .attr("fill",d=>d.color);

  svg.selectAll(".bar-label")
    .data(data).enter().append("text")
    .attr("class","bar-label")
    .attr("x",d=>x(d.name)+x.bandwidth()/2)
    .attr("y",y(0)-5)
    .text("");

  barIndex=0;
}
$("#animateBarsBtn").addEventListener("click",()=>{
  const data=window.__lastSeats||[];
  if(barIndex>=data.length) return;
  const svg=d3.select("#barChart");
  const w=600,h=400;
  const x=d3.scaleBand().domain(data.map(d=>d.name)).range([60,w-20]).padding(0.3);
  const y=d3.scaleLinear().domain([0,d3.max(data,d=>d.pct)+5]).range([h-40,20]);

  const d=data[barIndex];
  svg.selectAll("rect.bar").filter(b=>b.name===d.name)
    .transition().duration(1000)
    .attr("y",y(d.pct))
    .attr("height",(h-40)-y(d.pct));

  svg.selectAll("text.bar-label").filter(b=>b.name===d.name)
    .transition().delay(1000).text(d.pct+"%").attr("y",y(d.pct)-5);

  barIndex++;
});

/* ===== Main ===== */
function recompute(){
  const totalSeats=parseInt($("#totalSeats").value)||0;
  const threshold=parseFloat($("#threshold").value)||0;
  const method=$("#method").value;
  const parties=$$("#partyList .party-row").map(r=>({
    name:r.querySelector(".pName").value,
    pct:parseFloat(r.querySelector(".pPct").value)||0,
    color:r.querySelector(".pColor").value
  }));
  const seats=computeSeats(parties,totalSeats,threshold,method);
  window.__lastSeats=seats;
  drawHalfRing(seats,totalSeats);
  renderLegend(seats);
  renderChecklist(seats);

  const majority=Math.floor(totalSeats/2)+1;
  const sum=seats.reduce((a,p)=>a+(selectedCoalition.has(p.name)?p.seats:0),0);
  $("#coalSeats").textContent=sum;
  $("#majorityLbl").textContent=majority;
  const ok=sum>=majority;
  $("#coalMajority").textContent=ok?"ja":"nein";
  $("#coalMajority").className=ok?"ok":"bad";

  drawBars(seats);
}
function addPartyRow(p={name:"Neue Partei",pct:0,color:"#8888ff"}){
  const row=document.createElement("div");
  row.className="party-row";
  row.innerHTML=`<div>⋮</div>
    <input class="pName" value="${p.name}">
    <input class="pPct" type="number" value="${p.pct}">
    <input class="pColor" type="color" value="${p.color}">
    <div></div><div class="del">✕</div>`;
  row.querySelector(".del").onclick=()=>{row.remove();recompute();};
  $("#partyList").appendChild(row);
}
function setDefaults(){
  $("#partyList").innerHTML="";
  defaultParties.forEach(addPartyRow);
  recompute();
}
$("#addRowBtn").onclick=()=>{addPartyRow();};
$("#calcBtn").onclick=recompute;
setDefaults();
</script>
</body>
</html>
